---
title: "Description et prévision de données temporelles"
author: "DIOP Mandir, GAMONDELE Maxime, SAMAKE Salif"
date: "2025-01-06"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


\newpage

\tableofcontents
\newpage

\section{Introduction}

Les futures sur matières premières sont des contrats financiers standardisés permettant d'acheter ou de vendre une quantité spécifique d'une matière première à un prix fixé, à une date future déterminée. Ces marchés sont cruciaux pour l'économie, car ils offrent aux entreprises et aux investisseurs un outil pour se protéger contre les fluctuations de prix (*hedging*) et permettent une meilleure visibilité sur les prix futurs grâce à la confrontation de l'offre et de la demande. En stabilisant les coûts et en attirant des capitaux via la spéculation, les futures contribuent à sécuriser les chaînes d'approvisionnement et à garantir la stabilité des marchés mondiaux.

Notre étude se concentre sur l’évolution de cinq cotations de futures sur matières premières, observées depuis 2010. Les indices étudiés sont les suivants :

- **Café** (*Futures café US C*)  
- **Cacao** (*Futures cacao US*)  
- **Jus d’orange** (*Futures jus d’orange*)  
- **Sucre** (*Futures sucre Londres*)  
- **Pétrole** (*Futures pétrole Brent*)  

Les données sont issues du site [investing.com](https://www.investing.com). Voici un extrait des variables de notre jeu de données.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.2\textwidth]{../images_rap/Logo/Screenshot.png}
    \caption{Variables du jeu de données.}
    \label{fig:variables}
\end{figure}

Nous proposons d'effectuer une analyse exploratoire divisée en deux parties : une étude global de nos cinq indices, puis un focus sur le pétrole Brent.




\newpage


\section{Analyse des cotations de cinq matières premières}

Cette première partie abordera l’analyse des données concernant les cinq futures cités précédemment. Nous allons étudier uniquement leurs valeurs à la fermeture du marché. On notera que ces contrats ne partagent pas tous les mêmes horaires de marché, bien que la majorité soit basée aux États-Unis, à l'exception du sucre, qui est coté sur le marché de Londres. Par exemple, les horaires pour le pétrole Brent sont de 2h00 à 22h00 (UTC+1) et pour le cacao de 10h50 à 19h30 (UTC+1).

\subsection{Boxplots annuels des cotations journalières (2010-2024)}

\vspace{0.2cm}

Ce premier graphique (cf. Fig.~\ref{graph_1}) met en avant les variations des cotations de chaque matière première sur la période 2010 à 2024. Par exemple, le cacao semble avoir une très faible volatilité entre 2010 et 2022. Sur les deux années suivantes, on observe une variation positive importante de notre cotation, ce qui explique l'écart significatif entre le Q1 et le Q3 ainsi que la longueur des moustaches. À l'inverse, on remarque que les variations semblent plus importantes pour le café et le sucre, qui présentent des écarts plus marqués entre le Q1 et le Q3.


``` {r chargement des librairies, include = FALSE}
library(dplyr)   
library(tidyr)      
library(lubridate)  
library(ggplot2)   
library(scales)   
library(stats)    
library(stringr)   
library(dplyr)
library(patchwork)
```

```{r chargement_jeu_de_donnees, include=FALSE}
data = readRDS("fichier_de_travail.rds")
```

```{r graph1, echo=TRUE, message=FALSE, warning=FALSE}
# ---------------------------------------------------------------------------- #
#.      1. Boxplots des closed cotation annuels pour chaque matière première   # 
# ---------------------------------------------------------------------------- #

data$Year <- year(data$Date)
data$Month <- floor_date(data$Date, "month")


# Graphique

ggplot(data, aes(x = factor(Year), y = Closed_Cotation, fill = Futures)) +
  geom_boxplot(outlier.size = 1, outlier.color = "black") +
  facet_wrap(~Futures, scales = "free_y") +
  labs(
    title = "Boxplots annuels des cotations journalières de clôture",
    x = "Année", 
    y = "Cotation de clôture (en $)",
    fill = "Matière première",
    subtitle = "Source : investing.com",
    caption = c("BUT Science des Données - Lisieux","Diop Mandir - Gamondele Maxime - Samake Salif")
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(hjust = 1, angle = 45),
    strip.text = element_text(face = "bold"), 
    legend.position = c(0.85, 0.2),  
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 24, face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 15),
    plot.subtitle = element_text(hjust = 0.5, colour = "blue4"),
    plot.caption = element_text(hjust = c(0, 1), face = "bold", colour = "blue4")
  )

```
``` {r graph2, echo=TRUE, message=FALSE, warning=FALSE}

# ---------------------------------------------------------------------------- #
#     2. Évolution mensuelle avec une courbe de régression lissée              # 
# ---------------------------------------------------------------------------- #

# Préparation des données pour le graph
# Calcul de la moyenne mensuelle pour chaque matière première
data_mois <- data %>%
  mutate(YearMonth = floor_date(Date, "month")) %>% 
  group_by(YearMonth, Futures) %>% 
  summarise(Moyenne_Cotation = mean(Closed_Cotation, na.rm = TRUE), .groups = "drop")

# Graphique
ggplot(data_mois, aes(x = YearMonth, y = Moyenne_Cotation, )) +
  geom_line(aes(color = Futures), size = 1.2) +  
  geom_smooth(method = "gam", se = FALSE, color = "black", size = 1) +  # ou bien loess avec un span à 0.25
  facet_wrap(~Futures, scales = "free_y") +  
  theme_bw() +
  labs(
    title = "Évolution moyenne mensuelle de la cotation journalière de chaque matière première",
    x = "Année",
    y = "Cotation (en $)",
    color = "Matières premières",
    subtitle = "Source : investing.com",
    caption = c("BUT Science des Données - Lisieux","Diop Mandir - Gamondele Maxime - Samake Salif")
  ) +
  theme(
    axis.text.x = element_text(hjust = 1, angle = 45),
    strip.text = element_text(face = "bold"), 
    legend.position = c(0.85, 0.2),  
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 24, face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 15),
    plot.subtitle = element_text(hjust = 0.5, colour = "blue4"),
    plot.caption = element_text(hjust = c(0, 1), face = "bold", colour = "blue4")
  )

```

``` {r graph3, echo=TRUE, message=FALSE, warning=FALSE}

# ---------------------------------------------------------------------------- #
#.   3. Taux d'évolution de la moyenne mensuelle des cotations journalières    # 
# ---------------------------------------------------------------------------- #

# Préparation des donnée pour le graphique
# Groupement et calcul de la moyenne mensuelle
data %>%
  group_by(Futures, Annee_mois = format(Date, "%Y-%m")) %>%
  summarize(moyenne_mensuelle = mean(Closed_Cotation, na.rm = TRUE)) -> data1
data1 <- data1 %>%
  group_by(Futures) %>%
  mutate(Taux_variation_mensuel = (moyenne_mensuelle - lag(moyenne_mensuelle)) / lag(moyenne_mensuelle) * 100)
data1 <- data1 %>%
  group_by(Futures) %>%
  mutate(Taux_variation_mensuel = c(NA, diff(moyenne_mensuelle) / moyenne_mensuelle[-length(moyenne_mensuelle)] * 100))
data1$Annee_mois <- as.Date(paste0(data1$Annee_mois, "-01"))

# Conversion de Annee_mois en date
data1$Annee_mois <- as.Date(paste0(data1$Annee_mois, "-01"))

# graphique
ggplot(data1, aes(x = Annee_mois, y = Taux_variation_mensuel, group = Futures, color = Futures)) +
  geom_line() +
  geom_smooth(method = 'loess') +
  facet_wrap(~ Futures, scales = "free_y") +
  labs(
    title = "Taux d'évolution de la moyenne mensuelle des cotations journalières",
    x = "Date",
    y = "Taux d'évolution (%)",
    color = "Matière première",
    subtitle = "Source : investing.com",
    caption = c("BUT Science des Données - Lisieux","Diop Mandir - Gamondele Maxime - Samake Salif")
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(hjust = 1, angle = 45),
    strip.text = element_text(face = "bold"), 
    legend.position = c(0.85, 0.2),  
    legend.text = element_text(size = 15),
    legend.title = element_text(size = 24, face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 15),
    plot.subtitle = element_text(hjust = 0.5, colour = "blue4"),
    plot.caption = element_text(hjust = c(0, 1), face = "bold", colour = "blue4")
  )
```


``` {r graph4, echo=TRUE, message=FALSE, warning=FALSE}

# ---------------------------------------------------------------------------- #
#.      4.Relation entre les valeurs moyennes mensuelles du café et du cacao  # 
# ---------------------------------------------------------------------------- #

# Étape 1 : Calcul des moyennes mensuelles pour le café
data_cafe <- data %>%
  filter(Futures == "Cotation du café") %>%
  mutate(Annee_mois = format(Date, "%Y-%m")) %>%
  group_by(Annee_mois) %>%
  summarize(Moyenne_Cafe = mean(Closed_Cotation, na.rm = TRUE)) %>%
  ungroup()

# Étape 2 : Calcul des moyennes mensuelles pour le cacao
data_cacao <- data %>%
  filter(Futures == "Cotation du cacao") %>%
  mutate(Annee_mois = format(Date, "%Y-%m")) %>%
  group_by(Annee_mois) %>%
  summarize(Moyenne_Cacao = mean(Closed_Cotation, na.rm = TRUE)) %>%
  ungroup()

# Étape 3 : Fusionner les deux jeux de données sur "Annee_mois"
jointure_mooyenne = merge(data_cafe, data_cacao, by = "Annee_mois", all = TRUE)

# Modèle de régression linéaire
model <- lm(Moyenne_Cacao ~ Moyenne_Cafe, data = jointure_mooyenne)
summary(model)
cor(jointure_mooyenne$Moyenne_Cacao, jointure_mooyenne$Moyenne_Cafe, method = "pearson")

# Nuage de points avec lissage et régression linéaire
ggplot(jointure_mooyenne, aes(x = Moyenne_Cafe, y = Moyenne_Cacao)) +
  geom_point(color = "blue", 
             size = 2, 
             alpha = 0.7, 
             shape = 21, 
             fill = "blue") + 
  geom_smooth(aes(color = "Régression linéaire"), 
              method = "lm", 
              se = FALSE, 
              size = 1) +  
  geom_smooth(aes(color = "Lissage"), 
              method = "loess", 
              se = TRUE, 
              size = 0.8) +  
  labs(
    title = "Relation entre les valeurs moyennes mensuelles du café et du cacao",
    x = "Moyenne mensuelle - Café",
    y = "Moyenne mensuelle - Cacao",
    subtitle = "Source : investing.com",
    caption = c("BUT Science des Données - Lisieux", "Diop Mandir - Gamondele Maxime - Samake Salif"),
    color = ""
  ) +
  scale_color_manual(values = c("Régression linéaire" = "green4", "Lissage" = "red")) + 
  theme_bw() +
  theme(
    legend.position = "bottom",  
    legend.justification = "center", 
    plot.title = element_text(hjust = 0.5, face = "bold", size = 15),
    plot.subtitle = element_text(hjust = 0.5, colour = "blue4"),
    plot.caption = element_text(hjust = c(0, 1), face = "bold", colour = "blue4"),
    legend.title = element_text(face = "bold"),  
    legend.text = element_text(size = 10)  
  ) +
  annotate(
    "text", 
    x = 125, 
    y = 8000, 
    label = " m(x) = 1186,5 + 10,8x\nR² = 15,56 %\np-val = 0", 
    fontface = "bold",
    color = "green4", 
    size = 3.5
  )

# Affichage de la P-value
cat(sprintf("P-value : %.5f\n", summary(model)$coefficients[2, 4]))
```

``` {r graph5_1, echo=TRUE, message=FALSE, warning=FALSE}

# ---------------------------------------------------------------------------- #
#          5.1 Etude du brent de 2010 à fin 2024 avec lissage                  #
# ---------------------------------------------------------------------------- #

# Préparation des donnée pour le graphique 

data_brent = filter(data,data$Futures == "Cotation du pétrole Brent") %>% 
  select(Date,Closed_Cotation) %>% 
  mutate(Month = floor_date(Date, "month")) %>%  
  group_by(Month) %>%
  summarise(Monthly_Avg_Closed_Cotation = mean(Closed_Cotation, na.rm = TRUE))


# Base du graphique
graph1 = chronique_reg(data_brent,
              "Évolution de la cotation de clôture mensuelle moyenne du pétrole Brent",
              "Monthly_Avg_Closed_Cotation",
              0.2,
              "Janvier 2010 - Octobre 2024",
              "Cotation (en $)",
              "Source : investing.com",
              c("BUT Science des Données - Lisieux","Diop Mandir - Gamondele Maxime - Samake Salif"))

# Ajout d'éléments de précision au graphique
# graphique de base + les dates clès
graph1 <- graph1 + 
  geom_vline(xintercept = as.Date("2016-01-01"),
             color = "purple",
             linetype = "dashed") + 
  annotate("text",
           x = as.Date("2016-01-01")+80,
           y = 30, 
           label = "Abondance de l'offre\njanvier 2016", 
           color = "purple", 
           hjust = 0)+ 
  geom_vline(xintercept = as.Date("2020-04-01"),
             color = "blue", 
             linetype = "dashed") + 
  annotate("text", 
           x = as.Date("2020-04-01") +80, 
           y = 30, label = "Crise du Covid-19\navril 2020", 
           color = "blue", 
           hjust = 0)
print(graph1)
```

``` {r graph5_2, echo=TRUE, message=FALSE, warning=FALSE}

# ---------------------------------------------------------------------------- #
#            5.2 Etude de la saisonnalité pour chaque année                    #
# ---------------------------------------------------------------------------- #

# Calcul de la tendance globale à l'aide de yt, mt et st
trend_brent = loess(Monthly_Avg_Closed_Cotation ~ as.numeric(Month),
                    data = data_brent, span = 0.2)

# Calcul de la saisonnalité st avec st = yt - mt
data_brent = data_brent %>%
  mutate(
    trend = predict(trend_brent), #mt
    saisonnalités = Monthly_Avg_Closed_Cotation - trend,  #st = yt - mt
    year = year(Month), 
    month_day = format(Month, "%m-%d")
  )

# Convertir month_day en Date
data_brent$month_day <- as.Date(paste("2010", data_brent$month_day, "01", sep = "-"))
Sys.setlocale("LC_TIME", "fr_FR.UTF-8") # mon ordi anglophone donc transformation en fr

# graphique en superposant les années pour visualiser si il y a une silmilitude
# d'année en année
ggplot(data_brent, aes(x = month_day, y = saisonnalités, color = factor(year), group = year)) +
  geom_line() +
  labs(
    title = "Composante saisonnière de la cotation du Pétrole Brent (2010-2024)",
    x = "Mois",
    y = "Variation (en $)",
    color = "Année",
    subtitle = "Source : investing.com",
    caption = c("BUT Science des Données - Lisieux","Diop Mandir - Gamondele Maxime - Samake Salif")
  ) +
  scale_x_date(labels = scales::date_format("%B"), breaks = "1 month") +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.direction = "horizontal",
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 15),
    plot.subtitle = element_text(hjust = 0.5, colour = "blue4"),
    plot.caption = element_text(hjust = c(0, 1), face = "bold", colour = "blue4")
  ) +
  guides(color = guide_legend(nrow = 1, byrow = TRUE))
```

``` {r graph5_3, echo=TRUE, message=FALSE, warning=FALSE}
```

``` {r graph5_4, echo=TRUE, message=FALSE, warning=FALSE}
```

``` {r graph5_5, echo=TRUE, message=FALSE, warning=FALSE}
```